---
title: "Projet de Séries Temporelles"
author: "Kim Antunez et Alain Quartier-la-Tente"
date: "19/05/2020"
automaticcontents: true
output:
  bookdown::pdf_document2:
        toc: true
        toc_depth: 3
        number_sections: true
        fig_width: 7
        fig_height: 6
        fig_caption: true
        highlight: default
        keep_tex: yes
urlcolor: blue
themeoptions: "coding=utf8,language=french"
classoption: 'french'
geometry: margin=0.95in
lang: "french"
documentclass: "article"
header-includes:
- \usepackage{fontawesome}
- \usepackage{multicol}
before_body-includes:
- \clearpage
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
  collapse = TRUE,
  fig.path = "img/rmd-",
  fig.align = "center",
  fig.width = 8, fig.height = 3,
  warning = FALSE,
  message = FALSE)
options(knitr.kable.NA = ' ')
source("fonctions_rapport.R",encoding = "UTF-8")
```

<!-- Pour faire en sorte que la première page ne soit pas numérotée : -->
\thispagestyle{empty}
\newpage\setcounter{page}{1}

# Partie 1 : Les données

## Question 1 : description de la série choisie

Pour ce projet, travaillons sur la série d'indice de production industrielle (IPI) dans l'industrie automobile (identifiant : 010537940). 
Il s'agit d'une série au niveau A64 de la nomenclature d'activités française révision 2 (NAF rév. 2), poste CL1.
L'industrie automobile concerne aussi bien la production des constructeurs de voitures particulières, de véhicules de loisir, de véhicules utilitaires que les équipementiers spécialisés, les carrossiers, les assembleurs ou les prestataires de services d’aménagement de véhicules automobiles. 
Cette production intègre donc la filière complète, y compris moteurs et organes mécaniques en amont, dès lors qu’ils sont principalement destinés à des véhicules automobiles (à l’exception des parties de moteur).

Il s'agit d'un indice de Laspeyres^[Les indices de Laspeyres et de Paasche permettent de synthétiser en un indice unique un certain nombre d'indices. L'indice de Laspeyres, le plus célèbre est l'IPC (indice des prix à la consommation).], en base 2015, chaîné avec des pondérations annuelles (les pondérations correspondant aux valeurs ajoutées des branches associées). 
L'IPI dans l'industrie automobile est calculé à partir de l'enquête mensuelle de branche, par agrégation de séries "élémentaires" estimées en volume^[La série d'IPI dans l'industrie automobile ne tient donc pas compte des variations de prix.], calculées à un niveau plus fin. 

Les séries de l'IPI sont corrigées des variations saisonnières et des jours ouvrables (CVS-CJO) à partir de la méthode X13-ARIMA. 
La désaisonnalisation est réalisée de manière indirecte : elle est effectuée à un niveau fin et les agrégats CVS-CJO sont ensuite calculés directement à partir de ces séries en agrégeant les séries CVS-CJO. 
Cette désaisonnalisation est réalisée par sous-périodes pour prendre en compte le fait que la structure économique des séries a beaucoup évolué en 30 ans, et donc qu'il serait peut pertinent d'appliquer un seul modèle de désaisonnalisation sur l'ensemble de la période. 
Ainsi, les modèles utilisés pour la désaisonnalisation commencent en 2005 et ces modèles sont utilisées pour estimer les séries CVS-CJO à partir de 2012.

Les séries CVS-CJO avant et après 2012 n'étant pas évaluées sur les mêmes modèles, l'idéal serait d'étudier notre série après janvier 2012 pour éviter des ruptures liées à ce changement de modèle. En revanche, cela laisserait une faible profondeur temporelle risquant de fragiliser l'estimation de nos modèles ARIMA. 
C'est pourquoi nous allons étudier la série d'IPI dans l'industrie automobile entre **janvier 2010 et décembre 2019**^[Les derniers points étant souvent sujets à révisions, nous avons préféré ne pas prendre en compte les points de janvier et février 2020.], c'est-à-dire sur **120 observations**.

Nous n'effectuons pas ici de correction de point atypique ou de transformation logarithmique.

## Questions 2 et 3 : transformation de la série

```{r ipiBrut, fig.cap= "IPI dans l'automobile (CVS-CJO sans traitement)", include=FALSE}
data <- readRDS(file = "data/donnees.RDS")
data_complet <- readRDS(file = "data/donnees_completes.RDS")
models_evalues <- readRDS(file = "data/models_evalues.RDS")
x <- data[,"ipi_cl1"]
x_st <- readRDS(file = "data/x_st.RDS")
x_complet <- data_complet[, "ipi_cl1"]

p1 <- AQLTools::graph_ts(window(x,
								start = c(2009,10),
								end = c(2020,2),
								extend = TRUE), x_lab = "Dates", y_lab = NULL, n_xlabel = 12)
p1
```

```{r compGraph, fig.cap= "IPI dans l'automobile (CVS-CJO) sans et avec différentiation"}
p1 <- AQLTools::graph_ts(window(x,
								start = c(2009,10),
								end = c(2020,2),
								extend = TRUE), 
								x_lab = "Dates", y_lab = NULL, n_xlabel = 6,
								titre = "(a) Sans différentiation")
p2 <- AQLTools::graph_ts(window(x_st,
								start = c(2009,10),
								end = c(2020,2),
								extend = TRUE), x_lab = "Dates", y_lab = NULL, n_xlabel = 6,
								titre = "(b) Avec différentiation")
p1 + p2 
```

Le graphique \@ref(fig:compGraph)-(a) ne montre pas de tendance linéaire déterministe nette sur la période 2010-2020 : on observe plutôt une alternance entre des périodes à tendance croissante (2010-2011, 2013-2018) et à tendance décroissante (2011-2013 et 2018-2020). 
La série de l'IPI dans l'automobile semble plutôt montrer une tendance stochastique : elle n'est sûrement **pas stationnaire**. Ceci est vérifié en faisant le test Dickey-Fuller augmenté (ADF) avec une constante non nulle et sans tendance : on ne rejette pas l'hypothèse de présence de racine unitaire au seuil de 5 \% (tableau \@ref(tab:tabTestsInit)). 
Ceci est également confirmé par le test de racine unitaire de Phillips-Perron, non rejeté au seuil de 5 \%, et par le test de stationnarité^[Ici, l'hypothèse alternative est la non-stationnarité de la série] de Kwiatkowski-Phillips-Schmidt-Shin (KPSS), rejeté au seuil de 5 \%. Nous **différencions** donc la série. 



```{r tabTestsInit}
adf <- adfTest(x, type = "c",lags = 2)
pp <- PP.test(x) 
kpss <- tseries::kpss.test(x)
t1 <- test_stationnarite(adf, pp, kpss,
                   titre = "Tests de racine unitaire et de stationnarité sur la série d'IPI dans l'automobile")
t1
```


D'après le graphique \@ref(fig:compGraph)-(b), la série différenciée semble **stationnaire**. 
Cette hypothèse est confirmée par le test de Dickey-Fuller augmenté, effectué avec une constante nulle et sans tendance, le test de Phillips-Perron et le test KPSS (tableau \@ref(tab:tabTestsDiff)).




```{r tabTestsDiff}
adf <- adfTest(x_st, type = "c",lags = 1)
pp <- PP.test(x_st) 
kpss <- tseries::kpss.test(x_st)
t2 <- test_stationnarite(adf, pp, kpss,
                   titre = "Tests de racine unitaire et de stationnarité sur la série différenciée d'IPI dans l'automobile")
t2
```


# Partie 2 : Modèles ARIMA

Afin de déterminer les ordres maximaux, $p_{max}$ et $q_{max}$, du modèle $ARMA(p,q)$ suivi par la série différenciée de l'IPI dans l'automobile, nous analysons les autocorrélogrammes et les autocorrélogrammes partiels (graphique \@ref(fig:acfPacf)). 
À partir de retard 2 (inclus), aucun autocorrélogramme est significatif à 5 \% : on en déduit que $p_{max} = 1$.
À partir de retard 2 (inclus), aucun autocorrélogramme partiel est significatif à 5 \%: on en déduit que $q_{max} = 1$.  
Ainsi, pour savoir quel(s) modèle(s) retenir, nous allons tester tous les modèles $ARMA(p,q)$ tels que $p\leq 1$ et $q\leq 1$.

```{r acfPacf, fig.cap="Autocorrélogrammes (ACF) et autocorrélogrammes partiels (PACF) pour la série différenciée de l'IPI dans l'automobile", fig.height=2}
reformat_graph_acf(ggAcf(x_st)) +
	reformat_graph_acf(ggPacf(x_st))
```


Quatre modèles ARMA ont donc été testés^[Ils ont été estimés sans constante.] afin de s'assurer de l'indépendance des résidus (tableau \@ref(tab:tablbtest)) et, si c'est bien le cas, de la significativité des coefficients associés aux ordres maximaux des parties AR et MA des modèles (tableau \@ref(tab:tabcoefs))  :

\begin{itemize}
\item \emph{ARMA(0,0)} : les résidus de ce modèle ne sont pas indépendants \faArrowCircleRight{} \textbf{modèle non retenu}

\item \emph{ARMA(1,0)} : les résidus de ce modèle ne sont pas indépendants \faArrowCircleRight{} \textbf{modèle non retenu}

\item \emph{ARMA(0,1)} : les résidus de ce modèle sont indépendants et le coefficient associé au MA(1) est significatif \faArrowCircleRight{} \textbf{modèle retenu}

\item \emph{ARMA(1,1)} : les résidus de ce modèle sont indépendants (tableau mais le coefficient associé au AR(1) n'est significatif \faArrowCircleRight{} \textbf{modèle non retenu}
\end{itemize}

Finalement, seul le modèle ARMA(0,1) est valide sur la série différenciée. Sur la série non différenciée de l'IPI automobile, on retient donc le modèle **ARIMA(0,1,1)** défini mathématiquement par :  

$$
\Delta X_t = \varepsilon_t - \underset{(0,09)}{0,38}\;\varepsilon_{t-1}
$$
$\varepsilon_t$ est bien un bruit blanc : les $(\varepsilon_t)_t$ sont indépendants (tableau \@ref(tab:tablbtest)), homoscédastiques (tableau \@ref(tab:tablb2test)) et suivent aussi une loi normale (tableau \@ref(tab:tabjb)).

Parmi l'ensemble des modèles testés, l'ARIMA(0,1,1) est aussi le modèle qui minimise les critères d'information (tableau \@ref(tab:aicbic)).

```{r aicbic}
format_ic(models_evalues, 
            titre = "Critères d'information des modèles ARIMA sur l'IPI de l'automobile")
```


# Partie 3 : Prévisions

## Question 6, 7 et 8 : construction d'un intervalle de confiance

On cherche désormais à faire une prévision de $X_t$ à l'horizon $T+2$. 
Notons $\theta_1$ le coefficient associé à la partie MA de notre modèle ARMA(0,1,1), qu'on estime par $\hat\theta_1\simeq -0,38$ en estimant le modèle entre janvier 2010 et décembre 2019. On a donc :
$$
\Delta X_T = \varepsilon_T + \theta_1\varepsilon_{T-1}
\iff 
X_T = X_{T-1} + \varepsilon_T + \theta_1\varepsilon_{T-1}
\quad\text{où}\quad
\varepsilon_t\overset{i.i.d}\sim\mathcal N(0,\sigma^2)
$$

Les prévisions de $X_{T+1}$ et $X_{T+2}$ réalisées à l'instant $T$, notées $\hat X_{T+1\vert T}$ et $\hat X_{T+2\vert T}$, vérifient l'équation :
$$
\begin{cases}
\hat X_{T+1\vert T}=X_T + \hat\theta_1\varepsilon_T \\
\hat X_{T+2\vert T}=\hat X_{T+1\vert T}
\end{cases}
$$
Les erreurs de prévision sont égales à :
$$
\begin{cases}
\hat \varepsilon_{T+1\vert T} = X_{T+1} - \hat X_{T+1\vert T}=
\varepsilon_{T+1}+(\theta_1-\hat\theta_1)\varepsilon_T
\\
\hat \varepsilon_{T+2\vert T} = X_{T+2} - \hat X_{T+2\vert T}=
\varepsilon_{T+2}+(1+\theta_1)\varepsilon_{T+1}+(\theta_1-\hat\theta_1)\varepsilon_T 
\end{cases}
$$
La construction d'un intervalle confiance de niveau $\alpha$ de $X_{T+h\vert T}$ pour $h \in \{1,2\}$ se base sur le test :
$$
\begin{cases}
(H_0)\::\:&\hat \theta_1 = \theta_1 \\
(H_1)\::\:&\hat \theta_1 \ne \theta_1 
\end{cases}
$$
Les $\varepsilon_t$ étant i.i.d., sous $(H_0)$ on a $\hat \varepsilon_{T+h\vert T} \overset{(H_0)}{\sim}\mathcal N(0,\sigma_h^2)$ avec $\sigma_1^2=\sigma^2$ et $\sigma_h^2=\sigma^2(1+(1+\theta_1)^2)$. En notant $q_{1-\frac \alpha 2}$ le quantile $1-\frac \alpha 2$ d'une loi $\mathcal N(0,1)$, il vient :
$$
\mathbb P_{(H_0)}\left(
\left\lvert
\frac{\hat \varepsilon_{T+h\vert T}}{\sigma_h}
\right\rvert\leq q_{1-\frac{\alpha}{2}}
\right)=
\mathbb P_{(H_0)}\left(
\left\lvert
\frac{X_{T+h} - \hat X_{T+h\vert T}}{\sigma_h}
\right\rvert\leq q_{1-\frac{\alpha}{2}}
\right)=
1-\alpha
$$
Un intervalle de confiance de $X_{T+h}$ de niveau $\alpha$ est donc :
\begin{equation}
IC_{1-\alpha}(X_{T+h}) = \left[
\hat X_{T+h\vert T}-q_{1-\frac \alpha 2}{\sigma}_h\;;\;
\hat X_{T+h\vert T}+q_{1-\frac \alpha 2}{\sigma}_h
\right]
(\#eq:icCourtTerme)
\end{equation}
Le problème est que $\sigma_h$ est inconnu, on l'estime donc par $\hat \sigma_h$ avec :
$$
\hat\sigma_1 = \hat\sigma=  \frac{1}{T-2}\sum_{t=2}^T\hat\varepsilon_t^2
\text{ et }\quad
\hat\sigma_2=\hat\sigma\sqrt{1+(1+\hat \theta_1)^2}
$$
En remplaçant $\sigma_h$ par $\hat\sigma_h$, les intervalles de confiance définis dans l'équation \@ref(eq:icCourtTerme) restent valides mais **asymptotiquement uniquement**^[
Du fait de la forme simple de notre modèle ARIMA(0,1,1), on pourrait calculer un intervalle de confiance à court terme de $X_{T+1}$ en remplaçant $q_{1-\frac\alpha 2}$ par le quantile $1-\frac\alpha 2$ d'une loi de Student de degré $T-2$. Ce n'est cependant par possible pour $X_{T+2}$ et pour des modèles plus compliqués. 
], grâce au théorème de Slutsky (les estimateurs précédents des variances étant fortement consistants). 
En somme, on obtient les estimateurs suivants pour $X_{T+1}$ et $X_{T+2}$ :
\begin{equation}
IC_{1-\alpha}\left(\begin{pmatrix} \hat X_{T+1\vert T}
\\ \hat X_{T+2\vert T}\end{pmatrix}\right) =
\left[
  \begin{pmatrix} 
    X_T - \hat\theta_1\varepsilon_T 
    \\ X_T - \hat\theta_1\varepsilon_T 
  \end{pmatrix}
  -
  \hat\sigma q_{1-\frac \alpha 2}
  \begin{pmatrix} 
    1\\
    \sqrt{1+(1+\hat \theta_1)^2}
  \end{pmatrix}
  \;;\;
  \begin{pmatrix} 
    X_T - \hat\theta_1\varepsilon_T 
    \\ X_T - \hat\theta_1\varepsilon_T 
  \end{pmatrix}
  +
  \hat\sigma q_{1-\frac \alpha 2}
  \begin{pmatrix} 
    1\\
    \sqrt{1+(1+\hat \theta_1)^2}
  \end{pmatrix}
\right]
(\#eq:icPrev)
\end{equation}

Pour obtenir ces intervalles de confiance il faut que $T$ grand (dans notre cas $T=120$) et que les résidus de notre modèle ARIMA soient indépendants, homoscédastiques et suivent une loi normale : ce qui est bien vérifié dans notre cas. 

```{r prevIpi, fig.cap= "Prévisions de l'IPI automobile CVS-CJO pour janvier et février 2020 par un modèle ARIMA(0,1,1)"}
ordres_retenus <- readRDS(file = "data/ordres_retenus.RDS")
model_estime <- Arima(x, order = ordres_retenus, include.constant = FALSE)
prev <- forecast(model_estime, h = 2)

graph_prev(x, x_complet, prev, n_xlabel = 12)
```


Le graphique \@ref(fig:prevIpi) montre cette région de confiance au seuil 95 \%, ainsi que les valeurs actuelles de l'IPI automobile de janvier et de février 2020. 
On retrouve ce que l'on a montré par l'équation \@ref(eq:icPrev) : on prévoit la même valeur en $X_{T+1}$ et $X_{T+2}$ et plus l'horizon augmente plus l'incertitude autour de la prévision (i.e : l'intervalle de confiance) augmente. 
Cela parait peu cohérent économiquement de garder la même prévision pour les deux dates mais cela reflète la dynamique du modèle ARIMA(0,1,1) :

- Puisqu'il y a aucun ordre autorégressif, $\Delta X_t$ ne dépend pas des valeurs passées prises par $(\Delta X_{t'})_{t'\leq t-1}$.

- Puisque l'ordre MA est égale à 1, il n'y a aucune influence du bruit à l'horizon supérieur ou égal à 2 : sans aucune information supplémentaire, la seule prévision possible pour $\Delta X_{t+h}$, $h\geq 2$, est une prévision nulle, et donc pour $X_{t+h}$ la seule prévision possible est $\hat X_{t+1\vert t}$. 
Cette incertitude se traduit par un intervalle de confiance très grand^[On prévoit une évolution mensuelle entre janvier 2020 et décembre 2019 comprise entre -7,3 \% et +7,3 \%, ce qui est très grand compte tenu de la volatilité de la série (l'écart-type de la série en évolution est de 4,1, sa moyenne de 0,1).
] et une rapide augmentation de cet intervalle.




## Question 9 : question ouverte sur la causalité

Granger

\newpage

# (APPENDIX) Appendix {-}

# Annexe 1 : tests supplémentaires sur la qualité des modèles {#sec:qualRes}


```{r tablbtest}
format_testlb(models_evalues, 
            var = "lbtest",
            titre = "Tests de Ljung-Box sur les résidus (tests d'autocorrélation) des modèles ARIMA sur l'IPI de l'automobile")
```



```{r tabcoefs}
format_tab_coef(models_evalues, 
            titre = "Estimation des coefficients associés aux modèles ARIMA sur l'IPI de l'automobile")
```

```{r tablb2test}
format_testlb(models_evalues, 
            var = "lb2test",
            titre = "Tests de Ljung-Box sur le carré des résidus (tests d'homoscédasticité) des modèles ARIMA sur l'IPI de l'automobile") #%>% 
		#footnote(footnote_order= c("general","symbol"), #marche pas
		#		 symbol = "",
		#		 symbol_manual = c(''))
```


```{r tabjb}
format_jbtest(models_evalues, 
            titre = "Tests de Jarque-Bera de normalité des résidus des modèles ARIMA sur l'IPI de l'automobile") #%>% 
		# footnote(footnote_order= c("symbol","general"), #marche pas
		# 		 symbol = "\n\nL’hypothèse (H0) de normalité des résidus n’est pas rejetée à 5 % pour l’ensemble des modèles\net en particulier pour le modèle retenu ARIMA(0,1,1).",
		# 		 symbol_manual = c(''))
```
